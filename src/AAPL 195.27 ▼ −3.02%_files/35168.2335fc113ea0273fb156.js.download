"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[35168],{306543:(e,t,i)=>{i.d(t,{getServerInterval:()=>n});var s=i(477786);function n(e){return s.Interval.isRange(e)?"1":e}},482707:(e,t,i)=>{i.d(t,{createDwmAligner:()=>d,createTimeToBarTimeAligner:()=>u});var s=i(493239),n=i(213377),r=i(477786),o=i(831116),l=i(807780);const a=new o.SessionInfo("Etc/UTC","0000-0000:1234567");function d(e,t){if(!h()||!r.Interval.isDWM(e))return null;const i=new o.SessionInfo(t.timezone,t.session,t.session_holidays,t.corrections),n=(0,l.newBarBuilder)(e,i,a);return{timeToSessionStart:e=>n.tradingDayToSessionStart(e),timeToExchangeTradingDay:e=>{const t=(0,s.utc_to_cal)(i.timezone,e),n=i.spec.correctTradingDay(t);return(0,s.set_hms)(n,0,0,0,0,(0,s.get_timezone)("Etc/UTC")),n.getTime()}}}function h(){return!n.enabled("disable_resolution_rebuild")}function u(e,t){if(!h())return e=>e;const i=new o.SessionInfo(t.timezone,t.session,t.session_holidays,t.corrections),s=(0,l.newBarBuilder)(e,i,i,!1);return e=>s.alignTimeIfPossible(e)}},744380:(e,t,i)=>{i.d(t,{IntervalsVisibilitiesProperty:()=>r});var s=i(905520),n=i(816541);class r extends s.Property{state(e,t){return(0,n.nonDefaultIntervalsVisibilities)(super.state(e,t))??void 0}storeStateIfUndefined(){return!1}}},63358:(e,t,i)=>{i.d(t,{isLineTool:()=>n});var s=i(130551);function n(e){return(0,s.isObject)(e)&&"isLineTool"in e&&e.isLineTool}},790394:(e,t,i)=>{i.d(t,{LineDataSourcePointIndexProperty:()=>n});var s=i(905520);class n extends s.Property{constructor(e,t){super(),this._waitingPointsetUpdate=!1,this._lineSource=e,this._pointIndex=t,this._cachedIndex=this.value()}value(){const e=this._lineSource.points();return 0===e.length?this._cachedIndex:e[this._pointIndex].index}setValue(e){this._cachedIndex=e;const t=this._lineSource.points(),i=e=>{const t=this._lineSource.points()[this._pointIndex];if(t.index===e)return;t.index=e,this._lineSource.startChanging(this._pointIndex,t),this._setPointImpl(t),this._lineSource.model().updateSource(this._lineSource),this._listeners.fire(this,"");const i=this._lineSource.endChanging(!0,!1);this._lineSource.syncMultichartState(i)};if(0===t.length){const e=()=>{i(this._cachedIndex),this._waitingPointsetUpdate=!1};if(this._waitingPointsetUpdate)return;this._lineSource.pointsetUpdated().subscribe(this,e,!0),this._waitingPointsetUpdate=!0}else i(e)}_setPointImpl(e){this._lineSource.setPoint(this._pointIndex,e)}}},231842:(e,t,i)=>{i.d(t,{LineToolPriceAxisView:()=>o});var s=i(650151),n=i(597331),r=i(534328);class o extends n.PriceAxisView{constructor(e,t){super(),this._source=e,this._data=t,this._properties=e.model().properties().childs().scalesProperties}_updateRendererData(e,t,i){e.visible=!1;const s=this._source.model();if(!s.timeScale()||s.timeScale().isEmpty())return;const n=this._source.priceScale();if(null===n||n.isEmpty())return;if(!s.selection().isSelected(this._source)&&!this._source.isForcedDrawPriceAxisLabel())return;if(null===s.timeScale().visibleBarsStrictRange())return
;const o=this._source.priceAxisPoints(),l=this._data.pointIndex;if(o.length<=l)return;const a=o[l];if(!isFinite(a.price))return;const d=this._source.ownerSource(),h=null!==d?d.firstValue():null;if(null===h)return;let u=this._data.backgroundPropertyGetter?this._data.backgroundPropertyGetter():null;null===u&&(u=this._getBgColor()),i.background=(0,r.resetTransparency)(u),i.borderColor="#2E84A6",i.textColor=this.generateTextColor(i.background),i.coordinate=n.priceToCoordinate(a.price,h),e.text=this._formatPrice(a.price,h),e.visible=!0}_getBgColor(){return this._active?this._properties.childs().axisLineToolLabelBackgroundColorActive.value():this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}_formatPrice(e,t){return(0,s.ensureNotNull)(this._source.priceScale()).formatPrice(e,t)}}},515779:(e,t,i)=>{i.d(t,{LineDataSourceTimeAxisView:()=>n});var s=i(87521);class n extends s.TimeAxisView{constructor(e,t){super(e.model()),this._active=!1,this._source=e,this._pointIndex=t,this._properties=e.model().properties().childs().scalesProperties}setActive(e){this._active=e}_getBgColor(){return this._active?this._properties.childs().axisLineToolLabelBackgroundColorActive.value():this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}_getIndex(){if(!this._model.selection().isSelected(this._source))return null;const e=this._source.timeAxisPoints();return e.length<=this._pointIndex?null:e[this._pointIndex].index}_isVisible(){return!0}}},318945:(e,t,i)=>{i.d(t,{LineDataSource:()=>q,changePointUndoText:()=>K});var s=i(338561),n=i(86441),r=i(650151),o=i(536794),l=i(251954),a=i(735566),d=i(213377),h=i(482707),u=i(846195),c=i(547465),_=i(586563),p=i(677500),y=i(75060),m=i(234938),g=i(461820),S=i(972806),v=i(820028),f=i(239949),P=i(306543),b=i(816541),C=i(266954),A=i(388741),w=i(616427),I=i(477786),T=i(905520),x=i(87913),V=i(644036),L=i(744380),D=i(437642),M=i(678949),E=i(418450),F=i(790394);class N extends T.Property{constructor(e,t){super(),this._lineSource=e,this._pointIndex=t,e.pointAdded().subscribe(this,(e=>{this._pointIndex===e&&this._listeners.fire(this,`${e}`)})),e.pointChanged().subscribe(this,(e=>{this._pointIndex===e&&this._listeners.fire(this,`${e}`)}))}value(){const e=this._lineSource.points()[this._pointIndex].price,t=(0,r.ensureNotNull)(this._lineSource.ownerSource()).formatter();if(t.parse){const i=t.format(e),s=t.parse(i);return s.res?s.value:e}return e}setValue(e){const t=this._lineSource.points()[this._pointIndex];t.price=parseFloat(""+e),this._lineSource.startChanging(this._pointIndex,t),this._lineSource.setPoint(this._pointIndex,t),this._lineSource.model().updateSource(this._lineSource),this._listeners.fire(this,"");const i=this._lineSource.endChanging(!0,!1);this._lineSource.syncMultichartState(i)}}var k=i(515779),U=i(231842),z=i(702067),O=i(772062),R=i(85858),B=i(881727);const H=(0,a.getLogger)("Chart.LineDataSource"),W=d.enabled("datasource_copypaste");class G{constructor(){this._states=[]}start(e){this._states.push(e)}finish(e){const t=(0,r.ensureDefined)(this._states.pop())
;return s=t,(i=e).length!==s.length?{indexesChanged:!0,pricesChanged:!0}:i.reduce(((e,t,i)=>{const n=s[i];return e.indexesChanged=e.indexesChanged||t.index!==n.index,e.pricesChanged=e.pricesChanged||t.price!==n.price,e}),{indexesChanged:!1,pricesChanged:!1});var i,s}isEmpty(){return 0===this._states.length}}let $=0;const K=new E.TranslatedString("change point",s.t(null,void 0,i(776660)));class q extends V.DataSource{constructor(e,t,i,s){if(super(s),this.isLineTool=!0,this.version=1,this.toolname="",this.customization={forcePriceAxisLabel:!1,disableErasing:!1,disableSave:!1,showInObjectsTree:!0},this._currentPointsetAndSymbolId=null,this._pointChanged=new c.Delegate,this._pointAdded=new c.Delegate,this._priceAxisViews=[],this._timeAxisViews=[],this._timePoint=[],this._points=[],this._lastPoint=null,this._paneViews=new Map,this._normalizedPointsChanged=new c.Delegate,this._fixedPointsChanged=new c.Delegate,this._changeStatesStack=new G,this._startMovingPoint=null,this._currentMovingPoint=null,this._isActualSymbol=!1,this._isActualInterval=!1,this._isActualCurrency=!1,this._isActualUnit=!1,this._sharingMode=new v.WatchedValue(0),this._onTemplateApplying=new c.Delegate,this._onTemplateApplied=new c.Delegate,this._syncStateExclusions=["interval"],this._definitionsViewModel=null,this._hasEditableCoordinates=new v.WatchedValue(!0),this._syncLineStyleMuted=!1,this._onIsActualIntervalChange=new c.Delegate,this._onPointsetUpdatedDelegate=new c.Delegate,this._onServerUpdateTime=new c.Delegate,this._linkKey=new v.WatchedValue(null),this._serverUpdateTime=null,this._boundCalcIsActualSymbol=this.calcIsActualSymbol.bind(this),this._alignerCache=null,this._alertUndoMode=!1,this._onAlertStatusChanged=()=>{this.updateAllViewsAndRedraw((0,D.sourceChangeEvent)(this.id()))},this._model=e,this._properties=t,this._localAndServerAlertsMismatch=!1,this._properties.hasChild("interval")||this._properties.addChild("interval",new T.Property(e.mainSeries().interval())),this.calcIsActualSymbol(),this._properties.childs().intervalsVisibilities.subscribe(this,this.calcIsActualSymbol),this._properties.subscribe(this,this.propertiesChanged.bind(this,!1,void 0)),this.zOrderChanged().subscribe(this,this.propertiesChanged.bind(this,!0,void 0)),this._createPointsProperties(),this.pointsCount()>0)for(let e=0;e<this.pointsCount();e++)this._priceAxisViews.push(this.createPriceAxisView(e)),this._timeAxisViews.push(new k.LineDataSourceTimeAxisView(this,e));this._properties.childs().visible.subscribe(this,(e=>{const t=!1===(0,x.hideAllDrawings)().value();e.value()?e.value()&&t&&l.emit("drawing_event",this._id.value(),"show"):(this._model.selection().isSelected(this)&&this._model.selectionMacro((e=>{e.removeSourceFromSelection(this)})),t&&l.emit("drawing_event",this._id.value(),"hide")),this._onSourceHiddenMayChange()})),(0,x.hideAllDrawings)().subscribe(this,this._onSourceHiddenMayChange),this._sessionConnected=this._model.chartApi().isConnected().spawn(),this._sessionConnected.subscribe((e=>{e||(this._currentPointsetAndSymbolId=null)})),
this._alertStatus.subscribe(this._onAlertStatusChanged),this._definitionsViewModel=null,this._properties.setNameInOwner((0,B.propertyPathForSource)(this))}destroy(){this._paneViews.forEach(((e,t)=>this._destroyPanePaneViews(t))),this.stop(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),null!==this._ownerSource&&(this._ownerSource.currencyChanged().unsubscribeAll(this),this._ownerSource.unitChanged().unsubscribeAll(this),(0,M.isSymbolSource)(this._ownerSource)&&(this._ownerSource.symbolResolved().unsubscribeAll(this),this._ownerSource.isActingAsSymbolSource().unsubscribe(this._boundCalcIsActualSymbol))),this.ownerSourceChanged().unsubscribeAll(this),(0,x.hideAllDrawings)().unsubscribeAll(this),this.deleteAlert(),this._sessionConnected.destroy(),this._alertStatus.unsubscribe(this._onAlertStatusChanged),this._properties.destroy(),super.destroy()}setId(e){super.setId(e),this._properties.setNameInOwner((0,B.propertyPathForSource)(this))}priceScale(){return this._ownerSource?this._ownerSource.priceScale():null}createPriceAxisView(e){return new U.LineToolPriceAxisView(this,{pointIndex:e})}model(){return this._model}symbol(){return this._properties.childs().symbol.value()}linkKey(){return this._linkKey}serverUpdateTime(){return this._serverUpdateTime}setServerUpdateTime(e){this._serverUpdateTime=e,this._onServerUpdateTime.fire()}serverUpdateTimeChanged(){return this._onServerUpdateTime}boundToSymbol(){return!0}isAvailableInFloatingWidget(){return!0}points(){const e=[];for(let t=0;t<this._points.length;t++){const i=this._points[t];e.push({index:i.index,price:i.price,time:i.time})}return this._lastPoint&&e.push(this._correctLastPoint(this._lastPoint)),!this.isFixed()&&this._currentMovingPoint&&this._startMovingPoint&&this._correctPoints(e),e}timeAxisPoints(){return this.points()}priceAxisPoints(){return this.points()}fixedPoint(){if(!this.isFixed())return;let e;const t=this.priceScale();if(this._positionPercents&&null!==t&&!t.isEmpty()){const i=this._positionPercents,s=this._model.timeScale().width()*i.x,r=t.height()*i.y;e=new n.Point(s,r)}else void 0!==this._fixedPoint&&(e=this._fixedPoint?.clone());if(this._currentMovingPoint&&this._startMovingPoint&&void 0!==e){const t=this._correctFixedPoint(e);t.didCorrect&&(e=t.point)}return e}positionPercents(){return this.isFixed()?this._positionPercents:void 0}clearFixedPoint(){this._fixedPoint=void 0,this._positionPercents=void 0}normalizedPoints(){return this._timePoint}normalizedPointsForCreating(){return this.normalizedPoints()}normalizedPointsChanged(){return this._normalizedPointsChanged}fixedPointChanged(){return this._fixedPointsChanged}geometry(){const e=(0,r.ensureNotNull)(this.priceScale());return this.points().map((t=>{const i=(0,r.ensureNotNull)(this.pointToScreenPoint(t)),s=i.x/this._model.timeScale().width(),o=i.y/e.height();return new n.Point(s,o)}))}widthsProperty(){return this._properties.childs().linesWidths??null}lineColorsProperty(){return this._properties.childs().linesColors??null}
backgroundColorsProperty(){return this._properties.childs().backgroundsColors??null}textColorsProperty(){return this._properties.childs().textsColors??null}pointsProperty(){return this._pointsProperty}hasEditableCoordinates(){return this._hasEditableCoordinates}startMoving(e,t,i,s){this.isFixed()&&this.restoreFixedPoint(),this._startMovingPoint=e}move(e,t,i,s){if(i&&(i.shiftOnly()||i.modShift()))if(this.isFixed()){const t=this._alignScreenPointHorizontallyOrVertically((0,r.ensureDefined)(e.screen));this._currentMovingPoint={screen:t}}else{const t=this._alignPointHorizontallyOrVertically((0,r.ensureDefined)(e.logical)),i=(0,r.ensureNotNull)(this.pointToScreenPoint(t));this._currentMovingPoint={logical:t,screen:i}}else this._currentMovingPoint=e;this.updateAllViews((0,D.sourceChangeEvent)(this.id()))}endMoving(e,t,i){let s=!1,n=!1;if(this._currentMovingPoint&&this._startMovingPoint){if(this.isFixed()){const e=this._correctFixedPoint((0,r.ensureDefined)(this._fixedPoint));e.didCorrect&&(this._fixedPoint=e.point,this._fixedPointsChanged.fire())}else{const e=(0,r.ensureDefined)(this._currentMovingPoint.logical),t=(0,r.ensureDefined)(this._startMovingPoint.logical);s=e.index!==t.index,n=e.price!==t.price;if(this._correctPoints(this._points,i)){const e=this._id.value();l.emit("drawing_event",e,"move"),l.emit("drawing_event",e,"points_changed");for(let e=0;e<this._points.length;e++)this._pointChanged.fire(e)}}this._startMovingPoint=null,this._currentMovingPoint=null}const o={indexesChanged:s,pricesChanged:n};return this.isFixed()?(this.calcPositionPercents(),this.updateAllViews((0,D.sourceChangeEvent)(this.id())),o):(s&&this._points.forEach((e=>e.interval=this._model.mainSeries().interval())),this.updateAllViews((0,D.sourceChangeEvent)(this.id())),s&&!e?(this._properties.childs().interval.setValue(this._model.mainSeries().interval()),this._normalizePoints(),this.createServerPoints()):(this._copyPricesWithoutNormalization(),this._normalizedPointsChanged.fire()),t||!n&&!s||this.synchronizeAlert(!this._alertUndoMode),o)}startMovingPoint(){return this._startMovingPoint?{...this._startMovingPoint}:null}currentMovingPoint(){return this._currentMovingPoint?{...this._currentMovingPoint}:null}changePointUndoText(e){return K}startChanging(e,t){this.isFixed()&&this.restoreFixedPoint(),void 0!==e&&void 0!==t&&(e<this._priceAxisViews.length&&this._priceAxisViews[e].setActive(!0),e<this._timeAxisViews.length&&this._timeAxisViews[e].setActive(!0)),this._changeStatesStack.start(this.points())}endChanging(e,t,i){const s=this._changeStatesStack.finish(this.points());s.indexesChanged&&this._changeStatesStack.isEmpty()?(this._normalizePoints(),t||this.createServerPoints()):(this._copyPricesWithoutNormalization(),this._normalizedPointsChanged.fire()),l.emit("drawing_event",this._id.value(),"points_changed");for(let e=0;e<this._priceAxisViews.length;e++)this._priceAxisViews[e].setActive(!1);for(let e=0;e<this._timeAxisViews.length;e++)this._timeAxisViews[e].setActive(!1);return i||this.synchronizeAlert(!e),s}setPoint(e,t,i,s){
if(this._snapTo45DegreesApplicable(i)){const i=0===e?1:e-1;this.snapPoint45Degree(t,this.points()[i])}this._setPoint(e,{...t,interval:this._model.mainSeries().interval()})}getPoint(e){return this.points()[e]||null}alignCrossHairToAnchor(e){return!0}alignCrossHairToMovePoint(){return!1}setLastPoint(e,t,i=!0){return this._lastPoint=i?this._preparePoint(e,t):e,this.updateAllViews((0,D.sourceChangeEvent)(this.id())),this._lastPoint}lastPoint(){return this._lastPoint}getChangePointForSync(e){return this.getPoint(e)}setPoints(e){const t=this._model.mainSeries().interval();this._points=e.map((e=>({...e,interval:e.interval??t})))}isForcedDrawPriceAxisLabel(){return this.customization.forcePriceAxisLabel}clearData(){this._points=[]}denormalizeTimePoints(){let e=[];const t=this._model.mainSeries().interval();for(let i=0;i<this._timePoint.length;i++){const s=this._model.timeScale().denormalizeTimePoint(this._timePoint[i]);if(void 0===s){e=[];break}e.push({index:s,price:this._timePoint[i].price,interval:this._timePoint[i].interval??t})}e.length>0&&(this._points=e)}restorePoints(e,t,i){const s=this._timePoint.length>0&&!(0,o.deepEquals)(this._timePoint,e)[0],n=this._properties.childs().interval.value();this._timePoint=e.map((e=>({...e,interval:e.interval??n})));const r=this._model.mainSeries().interval();this._points=t.map((e=>({...e,interval:r}))),i||this.denormalizeTimePoints(),s&&this._normalizedPointsChanged.fire()}restorePositionPercents(e){this._positionPercents=e,this.restoreFixedPoint()}calcIsActualSymbol(){const e=this.ownerSource();if(null===e)this._isActualSymbol=!1;else{const t=(0,r.ensureNotNull)(e.symbolSource()),i=t.symbolInfo();if(i){this._migrateSymbolProperty(i);const e=this._properties.childs().symbol,s=e.value();if(this._isActualSymbol=t.symbolSameAsCurrent(s),this._isActualSymbol){const n=(0,A.extractLineToolSymbolFromSymbolInfo)(i,t.symbol());(0,w.areEqualSymbols)(s,n)||(H.logWarn('Possible drawing "migrating" detected from "'+s+'" to "'+n+'"'),H.logWarn("Series symbolInfo: "+JSON.stringify(t.symbolInfo())),H.logWarn(`${(new Error).stack}`)),e.setValue(n)}}}this.calcIsActualInterval(),this.calcIsActualCurrency(),this.calcIsActualUnit(),this._onSourceHiddenMayChange()}calcIsActualCurrency(){const e=this.ownerSource();if(null===e)return void(this._isActualCurrency=!1);let t=this._properties.childs().currencyId.value();if(null!==t){const i=e.symbolSource();"pct"===t&&(this._properties.childs().currencyId.setValue(null),t=null),this._isActualCurrency=t===(0,A.symbolCurrency)(i.symbolInfo(),void 0,!0)}else{const t=(0,r.ensureNotNull)(e.symbolSource());this._isActualCurrency=null!==t.symbolInfo()&&!t.isConvertedToOtherCurrency()}this._onSourceHiddenMayChange()}calcIsActualUnit(){const e=this.ownerSource();if(null===e)return void(this._isActualUnit=!1);const t=this._properties.childs().unitId.value();if(null!==t)this._isActualUnit=t===(0,r.ensureNotNull)(e.symbolSource()).unit();else{const t=(0,r.ensureNotNull)(e.symbolSource());this._isActualUnit=null!==t.symbolInfo()&&!t.isConvertedToOtherUnit()}
this._onSourceHiddenMayChange()}calcIsActualInterval(){const e=this._isActualInterval,t=this._properties,i=this._model.mainSeries();this._isActualInterval=(0,b.isActualInterval)(I.Interval.parse(i.interval()),t.childs().intervalsVisibilities),!this._isActualInterval&&this._model.selection().isSelected(this)&&this._model.selectionMacro((e=>e.removeSourceFromSelection(this))),this._isActualInterval!==e&&this._onIsActualIntervalChange.fire(),this._onSourceHiddenMayChange()}paneViews(e){if(this.isSourceHidden())return null;const t=this._getPaneViews(this.isMultiPaneAvailable()?e:void 0);if(null===t)return null;if(1===t.length)return[t[0]];const i=[];for(let e=t.length-1;e>=0;--e)i.push(t[e]);return i}priceAxisViews(e,t){if(this.isFixed())return null;if(t!==this.priceScale()||this.isSourceHidden())return null;if(this._model.lineBeingEdited()===this){const e=this._model.linePointBeingEdited();if(null!==e&&e<this._priceAxisViews.length){const t=this._priceAxisViews.slice(),i=t[e];return t.splice(e,1),t.push(i),t}return this._priceAxisViews}return this._priceAxisViews}timeAxisViews(){if(this.isSourceHidden()||this.isFixed())return null;if(this._model.lineBeingEdited()===this){const e=this._model.linePointBeingEdited();if(null!==e&&e<this._timeAxisViews.length){const t=this._timeAxisViews.slice(),i=t[e];return t.splice(e,1),t.push(i),t}return this._timeAxisViews}return this._timeAxisViews}isSavedInChart(){return!this.customization.disableSave}isSavedInStudyTemplates(){return!1}setSavingInChartEnabled(e){this.customization.disableSave=!e}shouldBeRemovedOnDeselect(){return!1}getOrderTemplate(){return null}getSourceIcon(){return{type:"loadSvg",svgId:"linetool."+this.toolname}}alertId(){return this._alertId}async waitSettingAlertId(){this._pendingAlertIdPromise&&(this._alertId=await this._pendingAlertIdPromise)}async setAlert(e,t={}){if(!this.canHasAlert())throw new Error("Line data source can not has alert");if(this._pendingAlertIdPromise)return void H.logWarn("Setting alert of line data source will be ignored because alert is already being set");if((0,o.isPromise)(e)){this._pendingAlertIdPromise=e;try{await this.waitSettingAlertId()}finally{delete this._pendingAlertIdPromise}}else this._alertId=e;const i=(0,r.ensureDefined)(this._alertId);this._hasAlert.setValue(!0),this._alertStatus.setValue(1),this._removeAlertSubscriptions(),await this._syncAlertWithAlertFacade(t);const s=this.linkKey().value();s&&!t.sync&&this._syncLineStyleChanges(s,{},i)}async restoreAlert(e,t){if(!this.canHasAlert())throw new Error("Line data source can not has alert");this._alertId=e,this._hasAlert.setValue(!0);try{const e=await this.getAlert();if(!e)return;this._addAlertSubscriptions(e,t)}catch(e){this._removeAlertSubscriptions()}}editAlert(e){this.hasAlert().value()&&(0,p.getChartAlertsFacade)().then((t=>{t.openEditDialog((0,r.ensureDefined)(this._alertId),{dataSourceHub:this._model,actionSource:e,onAborted:e=>{e===S.AlertEditorAbortReason.AlertIsInvalid&&this.removeAlert()}})}))}async getAlert(){try{const e=await this._getChartAlert()
;if(!e)throw H.logError("Failed to get alert, alert will not be saved with drawing in chart"),new Error("got_no_alert");return e}catch(e){if("not_exists"===e)throw new Error(e);return H.logError(`Getting alert failed: ${e instanceof Error?e.message:e}`),null}}getAlertSync(){if(!this._alertId)return null;const e=(0,p.getChartAlertsFacadeIfCreatedBefore)();return null===e?null:e.getAlertSync(this._alertId)??null}async synchronizeAlert(e=!1){if(this.hasAlert().value()||this._pendingAlertIdPromise)return new Promise(((t,i)=>{setTimeout((async()=>{if(!this._isDestroyed)try{await this.waitSettingAlertId(),0===this._alertStatus.value()&&await this._syncAlertWithAlertFacade(),this.hasAlert().value()&&this._synchronizeAlert(e),t()}catch(e){i(e)}}),0)}))}syncAlert(e){this.hasAlert().value()||this.setAlert(e,{sync:!0})}stateForAlert(){if(!this.canHasAlert())return null;const e=this.state(),t={points:e.points,state:e.state,type:e.type,id:this.idForAlert(),title:this.translatedType(),interval:this._model.mainSeries().interval(),text:this._properties.childs().text?.value()??this._properties.childs().labelText?.value()},i=this._getAlertPlots();return i&&i.length>0&&(t.plots=i),t}getAlertIsActive(){if(!this._alertId)return!1;const e=this.getAlertSync();return Boolean(e&&e.active().value())}detachAlert(){this._removeAlertSubscriptions(),this._hasAlert.setValue(!1),this._alertId=void 0,this._alertStatus.setValue(0)}removeAlert(){this._alertId=void 0,this._hasAlert.setValue(!1),this._alertStatus.setValue(0),this._removeAlertSubscriptions()}deleteAlert(){if(!this.hasAlert().value()||void 0===this._alertId)return;const e=(0,p.getChartAlertsFacadeIfCreatedBefore)();e&&e.deleteAlert(this._alertId),this.removeAlert()}areLocalAndServerAlertsMismatch(){return this._localAndServerAlertsMismatch}showInObjectTree(){return this.customization.showInObjectsTree}setShowInObjectsTreeEnabled(e){this.customization.showInObjectsTree=e}start(){this.createServerPoints()}processHibernate(){this.canBeHibernated()?this.isStarted()&&this.stop():this.isStarted()||this.start()}canBeHibernated(){return this.isSourceHidden()}onData(e){"pointset_error"!==e.method?e.params.customId===this._currentPointsetIdWithPrefix()&&this._onPointsetUpdated(e.params.plots):H.logError(`Error getting pointset: ${e.params[0]} ${e.params[1]}`)}isBeingEdited(){return this===this._model.lineBeingEdited()}isActualSymbol(){return this._isActualSymbol}isActualCurrency(){return this._isActualCurrency}isActualInterval(){return this._isActualInterval}isActualUnit(){return this._isActualUnit}onIsActualIntervalChange(){return this._onIsActualIntervalChange}setOwnerSource(e){null!==this._ownerSource&&(this._ownerSource.currencyChanged().unsubscribeAll(this),this._ownerSource.unitChanged().unsubscribeAll(this)),null!==this._ownerSource&&(0,M.isSymbolSource)(this._ownerSource)&&(this._ownerSource.symbolResolved().unsubscribe(this,this._boundCalcIsActualSymbol),this._ownerSource.isActingAsSymbolSource().unsubscribe(this._boundCalcIsActualSymbol)),super.setOwnerSource(e),
e&&(this.setPriceScale(e.priceScale()),e.currencyChanged().subscribe(this,this.calcIsActualCurrency),e.unitChanged().subscribe(this,this.calcIsActualUnit),this.calcIsActualSymbol(),this._migrateZOrder(),this._updateAlertCreationAvailable()),(0,M.isSymbolSource)(e)&&(e.symbolResolved().subscribe(this,this._boundCalcIsActualSymbol),e.isActingAsSymbolSource().subscribe(this._boundCalcIsActualSymbol))}dataAndViewsReady(){return this._paneViews.size>0}pointAdded(){return this._pointAdded}pointChanged(){return this._pointChanged}pointsetUpdated(){return this._onPointsetUpdatedDelegate}pointToScreenPoint(e){const t=this._model.timeScale(),i=this.priceScale(),s=this.ownerSource()?.firstValue();if(!i||i.isEmpty()||t.isEmpty()||null==s)return null;const r=t.indexToCoordinate(e.index),o=i.priceToCoordinate(e.price,s);return new n.Point(r,o)}screenPointToPoint(e,t){const i=this.priceScale(),s=this.ownerSource()?.firstValue();if(null==s||!isFinite(s)||null===i)return null;const n=this._model.timeScale(),r=t?n.coordinateToFloatIndex(e.x):n.coordinateToIndex(e.x);return{price:i.coordinateToPrice(e.y,s),index:r}}calcMiddlePoint(e,t){return new n.Point((e.x+t.x)/2,(e.y+t.y)/2)}addPoint(e,t,i){const s=this._preparePoint(e,t);return this._addPointIntenal(s,t,i)}addFixedPoint(e){return this._fixedPoint=e,this.calcPositionPercents(),!0}calcPositionPercents(){const e=this.priceScale();if(!e||e.isEmpty()||void 0===this._fixedPoint)return;const t=this._fixedPoint.x/this._model.timeScale().width(),i=this._fixedPoint.y/e.height();return this._positionPercents={x:t,y:i},this._positionPercents}restoreFixedPoint(){this._fixedPoint=this.fixedPoint()}propertiesChanged(e,t){this.calcIsActualInterval(),this.updateAllViewsAndRedraw((0,D.sourceChangeEvent)(this.id())),t||this._syncLineStyleIfNeeded(e),e||void 0!==this._pendingPropertyChangedEvent||(this._pendingPropertyChangedEvent=setTimeout((()=>{this._pendingPropertyChangedEvent=void 0,l.emit("drawing_event",this._id.value(),"properties_changed")}),0))}state(e){const t={type:this.toolname,id:this.id(),state:this.properties().state(this._propertiesStateExclusions()),points:(0,_.deepCopy)(this._timePoint),zorder:this.zorder(),ownerSource:this.ownerSource()?.id()};return this.linkKey().value()&&(t.linkKey=this.linkKey().value()),0!==this._sharingMode.value()&&(t.sharingMode=this._sharingMode.value()),delete t.state.points,e&&(t.indexes=this._points),this.isFixed()&&(t.positionPercents=this._positionPercents||this.calcPositionPercents()),"version"in this&&1!==this.version&&(t.version=this.version),this._saveAlertIdInState()&&this.hasAlert().value()&&void 0!==this._alertId&&(t.alertId=this._alertId),t}updateAllViews(e){this.isSourceHidden()||"data-source-change"===e.type&&this._ignoreSourceEvent(e)||(this._updateAllPaneViews(e),this._priceAxisViews.forEach((t=>t.update(e))),this._timeAxisViews.forEach((t=>t.update(e))))}updateAllViewsAndRedraw(e){this.updateAllViews(e),this._model.updateSource(this)}tags(){return[this.toolname]}properties(){return this._properties}restoreExternalPoints(e,t){try{
if(this._timePoint=(0,_.deepCopy)(e.points),t.indexesChanged){if(this.properties().childs().interval.setValue(e.interval),!this.isActualSymbol())return void this._clearServerPoints();this.createServerPoints()}else{const t=Math.min(this._points.length,e.points.length);for(let i=0;i<t;i++)this._points[i].price=e.points[i].price}this.updateAllViewsAndRedraw((0,D.sourceChangeEvent)(this.id()))}finally{this._normalizedPointsChanged.fire()}}restoreExternalState(e){this.properties().mergeAndFire(e)}applyTemplate(e){this._onTemplateApplying.fire(e),this._applyTemplateImpl(e),this.calcIsActualSymbol(),this.updateAllViews((0,D.sourceChangeEvent)(this.id())),this.model().lightUpdate(),this._onTemplateApplied.fire()}template(){return this.properties().preferences()}isFixed(){return!1}anchorable(){return!1}isLocked(){const e=this.properties().child("frozen");return void 0!==e&&e.value()}isSourceHidden(){return!this._properties.childs().visible.value()||(0,x.hideAllDrawings)().value()&&this.canBeHidden()||!this._isActualInterval||!this._isActualSymbol||!this._isActualCurrency||!this._isActualUnit}isSynchronizable(){return this.priceScale()===this._model.mainSeries().priceScale()}copiable(){return W}cloneable(){return null!==this._ownerSource&&null!==this._ownerSource.firstValue()}movable(){return!0}allowsMovingBetweenPanes(){return!1}async getPropertyDefinitionsViewModel(){if(null===this._definitionsViewModel){const e=await this._getPropertyDefinitionsViewModelClass();return null===e||this._isDestroyed?null:(this._definitionsViewModel=new e(this._model.undoModel(),this),this._definitionsViewModel)}return this._definitionsViewModel}title(){return this.translatedType()}translatedType(){return O.lineToolsLocalizedNames[this.toolname]??"Line Tool"}name(){return"Line Tool"}createServerPoints(){if(!this._isActualSymbol)return;if(!this._model.chartApi().isConnected().value())return;if(this._clearServerPoints(),this._model.timeScale().isEmpty())return;if(0===this._timePoint.length&&this._points.length>0&&this._normalizePoints(),!this._readyToCreatePointset())return;const e=this._pointsForPointset();if(0===e.length)return;++$,this._currentPointsetAndSymbolId={pointsetId:$,symbolId:(0,r.ensureNotNull)(this._model.mainSeries().seriesSource().symbolInstanceId())};const t=(0,P.getServerInterval)(this.properties().childs().interval.value());this._model.chartApi().createPointset(this._currentPointsetIdWithPrefix(),"turnaround",this._currentPointsetAndSymbolId.symbolId,t,e,this.onData.bind(this))}finish(){}realign(){this.calcIsActualSymbol(),this.isFixed()||this.isSourceHidden()||this._model.lineBeingCreated()===this||this._model.lineBeingEdited()===this||this._currentPointsetAndSymbolId?.symbolId===this._model.mainSeries().seriesSource().symbolInstanceId()||this._clearServerPoints(),null===this._model.mainSeries().symbolInfo()&&(this._alignerCache=null),this.updateAllViews((0,D.sourceChangeEvent)(this.id()))}stop(){this._clearServerPoints()}restart(){this.isFixed()||(this._currentPointsetAndSymbolId=null,this.createServerPoints())}isStarted(){
return null!==this._currentPointsetAndSymbolId}convertYCoordinateToPriceForMoving(e,t){const i=(0,r.ensureNotNull)(this.priceScale());if(i.isEmpty())return null;const s=this.ownerSource(),n=(0,r.ensure)((s||t)?.firstValue());return i.coordinateToPrice(e,n)}syncMultichartState(e){const t={points:this._timePoint,pointPositionPercents:this.positionPercents(),interval:this._model.mainSeries().interval()},i=this.linkKey().value();if(null!==i&&this.isSynchronizable()){const s={model:this._model,linkKey:i,symbol:this._model.mainSeries().symbol(),finalState:t,changes:e};(0,x.finishChangingLineTool)(s)}}enableCurrentIntervalVisibility(){let e=this.properties().childs().intervalsVisibilities.state();void 0!==e&&(e=(0,b.mergeIntervalVisibilitiesDefaults)(e),(0,b.makeIntervalsVisibilitiesVisibleAtInterval)(e,this._model.mainSeries().intervalObj().value()),this.properties().childs().intervalsVisibilities.mergeAndFire(e))}clonePositionOffset(){return this.isFixed()?{barOffset:0,xCoordOffset:20,yCoordOffset:20}:{barOffset:0,xCoordOffset:0,yCoordOffset:-40}}sharingMode(){return this._sharingMode}share(e){this.isSynchronizable()&&this._sharingMode.setValue(e)}syncLineStyleState(e){if(e)return{zOrder:this.zorder()};const{intervalsVisibilities:t,...i}=this.properties().state(this._syncStateExclusions);return{...i,intervalsVisibilities:(0,b.mergeIntervalVisibilitiesDefaults)(t),zOrder:this.zorder()}}moveLineTool(e){const t=this._model.mainSeries().interval();e.forEach(((e,i)=>this._setPoint(i,{...e,interval:t}))),this._normalizePoints()}snapTo45DegreesAvailable(){return!1}alignTo45DegreesPoints(){if(this.snapTo45DegreesAvailable()){const[e,t]=this.points();if(e&&t)return[{...e,pointIndex:0},{...t,pointIndex:1}]}return null}snapPoint45Degree(e,t,i){const s=this._model.timeScale(),n=s.indexToCoordinate(t.index),o=s.indexToCoordinate(e.index)-n,l=(0,r.ensureNotNull)(this.priceScale()),a=t.price,d=e.price,h=(0,r.ensureNotNull)((0,r.ensureNotNull)(this.ownerSource()).firstValue()),u=l.priceToCoordinate(a,h),c=l.priceToCoordinate(d,h)-u,_=Math.round(Math.atan2(o,c)/Math.PI*4);if(2===Math.abs(_))i||(e.price=a);else if(0===Math.abs(_)||4===Math.abs(_))i||(e.index=t.index);else{const t=Math.sqrt(o*o+c*c),i=o<0?-1:1,r=c<0?-1:1;let a=Math.max(Math.abs(c),Math.abs(o));a/=a*Math.sqrt(2)/t;const d=Math.round(s.coordinateToIndex(n+a*i)),_=Math.abs(s.indexToCoordinate(d)-n),p=l.coordinateToPrice(u+_*r,h);e.index=d,e.price=p}}contextMenuStatName(){return"LineToolContextMenu"}_ignoreSourceEvent(e){return e.sourceId!==this.id()}_pointsForPointset(){return this._timePoint.map((e=>e.interval?[e.time_t,e.offset,(0,P.getServerInterval)(e.interval)]:[e.time_t,e.offset]))}_setPoint(e,t){this._points[e]&&(this._points[e].index===t.index?this._points[e].price=t.price:this._points[e]=t,this._pointChanged.fire(e))}_correctLastPoint(e){return(0,o.clone)(e)}_snapTo45DegreesApplicable(e){return this.snapTo45DegreesAvailable()&&(e?.shift()||(0,x.alignTo45Degrees)().value())}_normalizePoint(e,t){return{...this._model.timeScale().normalizeBarIndex(e.index),price:e.price,
interval:e.interval}}_normalizePointWithoutOffset(e){const t=this._model.timeScale().indexToTimePoint(e.index)??this._utcTimeInCurrentResolution(e);return null===t?null:{price:e.price,time_t:t,offset:0,interval:e.interval}}_normalizePoints(){let e=[];const t=this._model.mainSeries().interval();for(let i=0;i<this._points.length;i++)if(I.Interval.isEqual(this._points[i].interval,t)){if(void 0!==this._points[i].index){const t=this._normalizePoint(this._points[i],i);if(!t.time_t){e=[];break}e.push(t)}}else e.push({...this._timePoint[i],price:this._points[i].price});this._timePoint=e,this._normalizedPointsChanged.fire()}_getStartBarAligner(){const e=this._model.mainSeries().interval();if(null===this._alignerCache||this._alignerCache.resolution!==this._model.mainSeries().interval()){const t=this._model.mainSeries().symbolInfo();if(!t)return null;this._alignerCache={resolution:e,aligner:(0,h.createTimeToBarTimeAligner)(e,t)}}return this._alignerCache.aligner}_utcTimeInCurrentResolution(e){const t=this._model.timeScale().points(),i=t.firstPoint(),s=t.lastPoint(),n=this._model.mainSeries().syncModel();if(null===i||null===s||null===n)return null;const o=(0,r.ensureNotNull)(t.indexOf(i,!1)),l=(0,r.ensureNotNull)(t.indexOf(s,!1));if(e.index>=o&&e.index<=l)return null;const a=e.index<o?o:l,d=(0,r.ensureNotNull)(t.valueAt(a)),h=e.index-a;return(0,u.extrapolateBarsFrontByCount)(n.barBuilder(),1e3*d,h).time/1e3}_setPaneViews(e,t,i){if(this._isDestroyed)for(const t of e)t.destroy&&t.destroy();else this._paneViews.set(t,e),void 0!==t&&i&&t.onDestroyed().subscribe(this,(()=>this._destroyPanePaneViews(t))),this._model.lightUpdate()}_getPaneViews(e){return this._paneViews.get(e)||null}_updateAllPaneViews(e){this._paneViews.forEach((t=>{for(const i of t)i.update(e)}))}_alignPointHorizontallyOrVertically(e){const t=(0,r.ensureNotNull)(this.pointToScreenPoint(e)),i=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).logical),s=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).screen),n=Math.abs(s.x-t.x),o=Math.abs(s.y-t.y);if(n<10&&o<10)return e;return{index:n<o?i.index:e.index,price:n<o?e.price:i.price}}_alignScreenPointHorizontallyOrVertically(e){const t=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).screen),i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y);return i<10&&s<10?e:i<s?new n.Point(t.x,e.y):new n.Point(e.x,t.y)}_correctPoints(e,t){const i=(0,r.ensure)(this._currentMovingPoint?.screen),s=(0,r.ensure)(this._startMovingPoint?.screen),n=i.subtract(s);if(n.length()<1&&!t)return!1;const o=Math.round((0,r.ensure)(this._currentMovingPoint?.logical).index-(0,r.ensure)(this._startMovingPoint?.logical).index);for(const t of e){const e=(0,r.ensureNotNull)(this.pointToScreenPoint(t)).add(n);t.index=t.index+o,t.price=(0,r.ensureNotNull)(this.screenPointToPoint(e)).price}return!0}_correctFixedPoint(e){if(void 0===this._fixedPoint)return{didCorrect:!1,point:e};const t=(0,r.ensureDefined)((0,r.ensureNotNull)(this._currentMovingPoint).screen),i=(0,r.ensureDefined)((0,
r.ensureNotNull)(this._startMovingPoint).screen),s=t.subtract(i);return s.length()>=1?{didCorrect:!0,point:e.add(s)}:{didCorrect:!1,point:e}}_currentPointsetIdWithPrefix(){return"pointset_"+(0,r.ensureNotNull)(this._currentPointsetAndSymbolId).pointsetId}_clearServerPoints(){null!==this._currentPointsetAndSymbolId&&this._model.chartApi().isConnected().value()&&this._model.chartApi().removePointset(this._currentPointsetIdWithPrefix()),this._currentPointsetAndSymbolId=null}_createPointProperty(e){const t=this._pointsProperty.childs().points;t.addChild(""+e,new T.Property({}));const i=t[e];i.addChild("price",new N(this,e)),i.addChild("bar",new F.LineDataSourcePointIndexProperty(this,e))}_createPointsProperties(){this._pointsProperty=new T.Property,this._pointsProperty.addChild("points",new T.Property);for(let e=0;e<this.pointsCount();e++)this._createPointProperty(e)}_alignPointToRangeOfActualData(e){const t=(0,r.ensureNotNull)(this._model.mainSeries().bars().firstIndex()),i=(0,r.ensureNotNull)(this._model.mainSeries().bars().lastIndex());let s=Math.max(e.index,t);return s=Math.min(s,i),{...e,index:s}}_migrateSymbolProperty(e){const t=this._properties.childs();if(t.symbolStateVersion.value()<2){const i=(0,r.ensureNotNull)(this.ownerSource()),s=(0,r.ensureNotNull)(i.symbolSource()),n=this._model.mainSeries();if(s===n)return void t.symbolStateVersion.setValueSilently(2);if(null===n.symbolInfo())return;if(null===s.symbolInfo())return;n.symbolSameAsCurrent(t.symbol.value())&&t.symbol.setValueSilently((0,A.extractLineToolSymbolFromSymbolInfo)(e,s.symbol())),t.symbolStateVersion.setValueSilently(2)}}_migrateZOrder(){const e=this._properties.childs();e.zOrderVersion.value()<2&&(this.ownerSource()===this.model().mainSeries()&&this.setZorder(this.zorder()-this.model().mainSeries().obsoleteZOrder()),e.zOrderVersion.setValueSilently(2))}_preparePoint(e,t){const i=e;return this._snapTo45DegreesApplicable(t)&&this.points().length>=2&&this.snapPoint45Degree(i,this.points()[this.points().length-2]),i}_addPointIntenal(e,t,i){this._points.push({...e,interval:this._model.mainSeries().interval()});const s=this._points.length===this.pointsCount();return s?(this._lastPoint=null,i||(this._normalizePoints(),this.createServerPoints())):this._lastPoint=e,this._pointAdded.fire(this._points.length-1),s}_onSourceHiddenMayChange(){this.isSourceHidden()&&this._model.selectionMacro((e=>{e.removeSourceFromSelection(this)})),this._model.invalidate(f.InvalidationMask.validateAction((()=>{this!==this._model.lineBeingCreated()&&(this._isDestroyed||this.processHibernate())})))}_saveAlertIdInState(){return!0}_onPointsetUpdated(e){if(0===e.length)return;const t=this.properties().childs().interval.value();for(let i=0;i<e.length;i++){const s=e[i],n=this._timePoint[s.index],r={index:s.value[0],time:s.value[1],price:n.price,interval:n.interval??t};this._points.length<=s.index?(this._points.push(r),this._pointAdded.fire(this._points.length-1)):(this._points[s.index]=r,this._pointChanged.fire(s.index))}{const e=this
;e.recalculateStateByData&&e.recalculateStateByData()}this._onPointsetUpdatedDelegate.fire(),this.updateAllViewsAndRedraw((0,D.sourceChangeEvent)(this.id()))}_onMainSeriesSymbolResolved(){const e=this.ownerSource();null===e||this._model.mainSeries()===e.symbolSource()||this.isSourceHidden()||this.createServerPoints()}_readyToCreatePointset(){return this._timePoint.length>0}_propertiesStateExclusions(){return[]}_syncLineStyleIfNeeded(e){const t=this.linkKey().value();t&&!this._syncLineStyleMuted&&this._syncLineStyleChanges(t,this.syncLineStyleState(e))}_muteSyncLineStyle(){this._syncLineStyleMuted=!0}_unmuteSyncLineStyleWithoutApplyingChanges(){this.propertiesChanged(),this._syncLineStyleMuted=!1}_applyTemplateImpl(e){e.intervalsVisibilities=(0,b.mergeIntervalVisibilitiesDefaults)(e.intervalsVisibilities);const t=this.properties();t.applyTemplate(e,(0,R.factoryDefaults)(this.toolname.toLowerCase())),t.saveDefaults(),this.propertiesChanged()}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_getAlertPlots(){return[]}_getUndoHistory(){return this._model.undoModel().undoHistory()}_synchronizeAlert(e){const t=this._getUndoHistory();if(!this._undoCheckpointAlert&&!this._alertUndoMode){const e=t.undoStack().pop();this._undoCheckpointAlert=t.createUndoCheckpoint(),e&&t.undoStack().push(e)}const i=e=>{const t=e.description()!==e.defaultDescription(),i=this._model.mainSeries().stateForAlert();e.startEditing(),e.setSymbol(i.symbolString);const s=(0,r.ensureNotNull)(this.stateForAlert());e.setResolution(s.interval),e.setLineState(s),t||e.resetToDefaultDescription(),e.finishEditing(),this._localAndServerAlertsMismatch=!0},s=()=>{this._alertUndoMode=!0,t.undoToCheckpoint((0,r.ensureDefined)(this._undoCheckpointAlert)),setTimeout((()=>{this._alertUndoMode=!1,this._localAndServerAlertsMismatch=!1}),0)},n=e=>{"not_exists"!==e&&(H.logError("Getting alert failed: "+e),s())},o=e=>{void 0!==this._alertRestartDebounceTimeoutId&&clearTimeout(this._alertRestartDebounceTimeoutId),this._alertRestartDebounceTimeoutId=setTimeout((async()=>{const t=await(0,p.getChartAlertsFacade)();this._isDestroyed||(t.restartAlert(e,{success:()=>this._localAndServerAlertsMismatch=!1,error:n,complete:()=>delete this._undoCheckpointAlert,actionSource:"drawing_sync"}),delete this._alertRestartDebounceTimeoutId)}),500)};(0,y.canPlaceAlertOnResolution)(this.stateForAlert().interval)?this.getAlert().then((t=>{t?(i(t),e&&o(t)):H.logError("Failed to get alert, drawing and alert are not synchronized")})).catch(n):this._alertUndoMode||((0,m.showGoProAlertsOnSecondsDialog)(),s(),delete this._undoCheckpointAlert)}_linePointsToAlertPlot(e,t,i,s){if(2!==e.length)return H.logError("[Drawing Alert] Wrong points"),null;const n=this._model.timeScale();return!n||n.isEmpty()?null:{type:"LinePlot",title:t||this.translatedType(),timestamp:(0,r.ensureNotNull)(n.indexToTimePoint(0)),offset1:e[0].index,offset2:e[1].index,price1:e[0].price,price2:e[1].price,extendBackward:i||!1,extendForward:s||!1}}_getAlertCreationAvailable(){
return g.alertsAvailable&&super._getAlertCreationAvailable()&&!this._areAlertsOnLineToolProhibited()&&!this._hasAlert.value()}_onAnchoredChange(){if(this.isFixed()){const e=(0,r.ensureNotNull)(this.pointToScreenPoint(this.points()[0]));this.addFixedPoint(e)}else{if(!this._fixedPoint)return;const e=(0,r.ensureNotNull)(this.screenPointToPoint(this._fixedPoint));this._points[0]={...e,interval:this._model.mainSeries().interval()},this.startChanging(),this.setPoint(0,e),this.endChanging(!1,!1),this._timePoint[0]=this._normalizePoint(this._points[0],0),this.clearFixedPoint()}const e=this.linkKey().value();null!==e&&this.isSynchronizable()&&(0,x.restoreLineToolState)({model:this._model,linkKey:e,state:this.state()})}_syncLineStyleChanges(e,t,i){this.anchorable()&&this.isFixed()!==Boolean(this._positionPercents)&&this._onAnchoredChange(),(0,x.changeLineStyle)({linkKey:e,state:t,alertId:i,model:this._model})}static _configureProperties(e){if(this._addCollectedProperties(e),e.hasChild("symbolStateVersion")||e.addChild("symbolStateVersion",new T.Property(1)),e.hasChild("zOrderVersion")||e.addChild("zOrderVersion",new T.Property(1)),e.hasChild("visible")||e.addChild("visible",new T.Property(!0)),e.hasChild("frozen")||e.addChild("frozen",new T.Property(!1)),e.hasChild("symbol")||e.addChild("symbol",new T.Property("")),e.hasChild("currencyId")||e.addChild("currencyId",new T.Property(null)),e.hasChild("unitId")||e.addChild("unitId",new T.Property(null)),e.hasChild("intervalsVisibilities")){const t=(0,o.merge)((0,o.clone)(C.intervalsVisibilitiesDefaults),e.childs().intervalsVisibilities.state());e.removeProperty("intervalsVisibilities"),e.addChild("intervalsVisibilities",new L.IntervalsVisibilitiesProperty(t))}else e.addChild("intervalsVisibilities",new L.IntervalsVisibilitiesProperty(C.intervalsVisibilitiesDefaults));e.hasChild("title")||e.addChild("title",new T.Property("")),["symbolStateVersion","zOrderVersion","visible","frozen","symbol","currencyId","unitId","symbolInfo","points","interval","title"].forEach((t=>e.addExcludedKey(t,5))),e.hasChild("singleChartOnly")&&e.removeProperty("singleChartOnly"),e.hasChild("font")&&e.removeProperty("font")}static _addCollectedProperties(e){e.hasChild("linewidth")&&e.addChild("linesWidths",new z.LineToolWidthsProperty([(0,r.ensureDefined)(e.child("linewidth"))])),e.hasChild("linecolor")&&e.addChild("linesColors",new z.LineToolColorsProperty([(0,r.ensureDefined)(e.child("linecolor"))])),e.hasChild("backgroundColor")&&e.addChild("backgroundsColors",new z.LineToolColorsProperty([(0,r.ensureDefined)(e.child("backgroundColor"))])),e.hasChild("textColor")&&e.addChild("textsColors",new z.LineToolColorsProperty([(0,r.ensureDefined)(e.child("textColor"))])),e.hasChild("linestyle")&&e.addChild("linesStyles",new z.LineToolCollectedProperty([(0,r.ensureDefined)(e.child("linestyle"))])),["linesWidths","linesColors","backgroundsColors","textsColors","linesStyles"].forEach((t=>{e.addExcludedKey(t,7)}))}_areAlertsOnLineToolProhibited(){
return null!==this._ownerSource&&!this._ownerSource.canHasAlertOnLineTools()}_removeAlertSubscriptions(){this._unsubscribeAlertCallbacks?.(),this._unsubscribeAlertCallbacks=void 0}_addAlertSubscriptions(e,t={}){if(void 0!==this._unsubscribeAlertCallbacks)return;const i=this.properties().child("extendLeft"),s=this.properties().child("extendRight"),n=e.destroyed().spawn(),r=e.selected().spawn(),o=e.hovered().spawn(),l=e.active().spawn();l.subscribe((e=>this._alertStatus.setValue(e?2:3)),{callWithLast:!0}),n.subscribe(this.removeAlert.bind(this)),r.subscribe((e=>{this._model.selectionMacro((t=>{e?t.addSourceToSelection(this):t.removeSourceFromSelection(this)}))}),{callWithLast:t.syncFocusFromAlert}),o.subscribe((e=>{const t=this._model.hoveredSource();e&&t!==this?this._model.setHoveredSource(this,null):e||t!==this||this._model.setHoveredSource(null,null)})),void 0!==i&&i.subscribe(this,(()=>this.synchronizeAlert(!1))),void 0!==s&&s.subscribe(this,(()=>this.synchronizeAlert(!1))),this._unsubscribeAlertCallbacks=()=>{n.destroy(),o.destroy(),r.destroy(),l.destroy(),void 0!==i&&i.unsubscribeAll(this),void 0!==s&&s.unsubscribeAll(this)}}_destroyPanePaneViews(e){const t=this._paneViews.get(e);if(void 0!==t)for(const e of t)e.destroy&&e.destroy();void 0!==e&&e.onDestroyed().unsubscribeAll(this),this._paneViews.delete(e)}_copyPricesWithoutNormalization(){const e=Math.min(this._points.length,this._timePoint.length);for(let t=0;t<e;t++)this._timePoint[t].price=this._points[t].price}async _getChartAlert(){const e=await(0,p.getChartAlertsFacade)();return new Promise(((t,i)=>{e.getAlert((0,r.ensureDefined)(this._alertId),{success:t,error:i})}))}async _syncAlertWithAlertFacade(e={}){try{const t=await this.getAlert();if(!t)return;if(this._addAlertSubscriptions(t,e),e.syncAlertFocus){const e=this._model.selection().isSelected(this);t.setSelected(e)}}catch(e){if(e instanceof Error&&"not_exists"===e.message&&this.hasAlert().value()){this._alertStatus.setValue(0);return void(await(0,p.getChartAlertsFacade)()).removeAlertFromAllChartsSilently(this.id(),(0,r.ensureDefined)(this._alertId))}H.logError("Failed to set alert, alert will not be saved with drawing in chart")}}}},702067:(e,t,i)=>{i.d(t,{LineToolCollectedProperty:()=>d,LineToolColorsProperty:()=>u,LineToolWidthsProperty:()=>h,MultipleLineColorsProperty:()=>p,MultipleLineWidthsProperty:()=>_});var s=i(735566),n=i(862150),r=i(421566);const o=(0,s.getLogger)("Chart.LineToolCollectedProperty");class l{applyValue(e,t){e.setValue(t)}}class a extends r.PropertyBase{constructor(e,t){super(),this._properties=e,e.forEach(((e,t)=>e.subscribe(this,((e,i)=>{this._listeners.fire(this,`${t}.${i}`)})))),this._showIfProperty=t}visible(){return!this._showIfProperty||this._showIfProperty?.value()}value(){if(0===this._properties.length)return o.logError("Incorrect call, should not request value of 0 properties"),"mixed";const e=this._properties[0].value();return 1===this._properties.length||this._properties.every((t=>t.value()===e))?e:"mixed"}setValueSilently(e){
"mixed"!==e&&this._properties.forEach((t=>t.setValueSilently(e)))}hasChild(e){const t=parseInt(e,10);return!isNaN(t)&&t>=0&&t<this._properties.length}childCount(){return this._properties.length}childNames(){return this._properties.map(((e,t)=>t.toString()))}child(e){const t=parseInt(e,10);return!isNaN(t)&&t>=0&&t<this._properties.length?this._properties[t]:void 0}destroy(){this._properties.forEach((e=>e.unsubscribeAll(this))),this._listeners.destroy()}storeStateIfUndefined(){return!0}weakReference(){return(0,n.weakReference)(this)}ownership(){return(0,n.ownership)(this)}}class d extends a{setValue(e,t,i){if("mixed"===e)return;const s=i??new l;this._properties.forEach((t=>s.applyValue(t,e)))}}class h extends d{}class u extends d{firstColor(){return this._properties[0].value()}}class c extends a{setValue(e,t,i){if("mixed"===e)return;const s=i??new l;this._properties.forEach((t=>t.setValue(e,void 0,s)))}}class _ extends c{}class p extends c{}},772062:(e,t,i)=>{i.d(t,{lineToolsLocalizedNames:()=>n});var s=i(444372);const n={LineTool5PointsPattern:s.t(null,void 0,i(942231)),LineToolABCD:s.t(null,void 0,i(246712)),LineToolArc:s.t(null,void 0,i(659324)),LineToolArrow:s.t(null,void 0,i(511858)),LineToolArrowMarkDown:s.t(null,void 0,i(673193)),LineToolArrowMarkLeft:s.t(null,void 0,i(401949)),LineToolArrowMarkRight:s.t(null,void 0,i(886275)),LineToolArrowMarkUp:s.t(null,void 0,i(162453)),LineToolBalloon:s.t(null,void 0,i(770540)),LineToolComment:s.t(null,void 0,i(309818)),LineToolBarsPattern:s.t(null,void 0,i(381994)),LineToolBezierCubic:s.t(null,void 0,i(77125)),LineToolBezierQuadro:s.t(null,void 0,i(678609)),LineToolBrush:s.t(null,void 0,i(243539)),LineToolCallout:s.t(null,void 0,i(925381)),LineToolCircleLines:s.t(null,void 0,i(584031)),LineToolCypherPattern:s.t(null,void 0,i(193191)),LineToolDateAndPriceRange:s.t(null,void 0,i(247017)),LineToolDateRange:s.t(null,void 0,i(485444)),LineToolDisjointAngle:s.t(null,void 0,i(91544)),LineToolElliottCorrection:s.t(null,void 0,i(980943)),LineToolElliottDoubleCombo:s.t(null,void 0,i(75112)),LineToolElliottImpulse:s.t(null,void 0,i(861114)),LineToolElliottTriangle:s.t(null,void 0,i(872359)),LineToolElliottTripleCombo:s.t(null,void 0,i(76129)),LineToolEllipse:s.t(null,void 0,i(978996)),LineToolExtended:s.t(null,void 0,i(452788)),LineToolFibChannel:s.t(null,void 0,i(659005)),LineToolFibCircles:s.t(null,void 0,i(182330)),LineToolFibRetracement:s.t(null,void 0,i(855986)),LineToolFibSpeedResistanceArcs:s.t(null,void 0,i(633880)),LineToolFibSpeedResistanceFan:s.t(null,void 0,i(202395)),LineToolFibSpiral:s.t(null,void 0,i(239014)),LineToolFibTimeZone:s.t(null,void 0,i(930622)),LineToolFibWedge:s.t(null,void 0,i(485042)),LineToolFlagMark:s.t(null,void 0,i(514600)),LineToolImage:s.t(null,void 0,i(868065)),LineToolFlatBottom:s.t(null,void 0,i(745051)),LineToolAnchoredVWAP:s.t(null,void 0,i(584541)),LineToolGannComplex:s.t(null,void 0,i(844763)),LineToolGannFixed:s.t(null,void 0,i(960707)),LineToolGannFan:s.t(null,void 0,i(748683)),LineToolGannSquare:s.t(null,void 0,i(947460)),
LineToolHeadAndShoulders:s.t(null,void 0,i(921928)),LineToolHorzLine:s.t(null,void 0,i(121795)),LineToolHorzRay:s.t(null,void 0,i(325487)),LineToolIcon:s.t(null,void 0,i(37913)),LineToolEmoji:s.t(null,void 0,i(273456)),LineToolSticker:s.t(null,void 0,i(443114)),LineToolInsidePitchfork:s.t(null,void 0,i(141686)),LineToolNote:s.t(null,void 0,i(986631)),LineToolTextNote:s.t(null,void 0,i(794389)),LineToolSignpost:s.t(null,void 0,i(467751)),LineToolParallelChannel:s.t(null,void 0,i(559256)),LineToolPitchfan:s.t(null,void 0,i(234156)),LineToolPitchfork:s.t(null,void 0,i(919634)),LineToolPolyline:s.t(null,void 0,i(401185)),LineToolPath:s.t(null,void 0,i(800371)),LineToolPrediction:s.t(null,void 0,i(920138)),LineToolPriceLabel:s.t(null,void 0,i(91282)),LineToolArrowMarker:s.t(null,void 0,i(936352)),LineToolPriceRange:s.t(null,void 0,i(768941)),LineToolProjection:s.t(null,void 0,i(375747)),LineToolRay:s.t(null,void 0,i(550318)),LineToolRectangle:s.t(null,void 0,i(426001)),LineToolCircle:s.t(null,void 0,i(191944)),LineToolRegressionTrend:s.t(null,void 0,i(802460)),LineToolRiskRewardLong:s.t(null,void 0,i(674832)),LineToolRiskRewardShort:s.t(null,void 0,i(508075)),LineToolFixedRangeVolumeProfile:s.t(null,{context:"study"},i(925705)),LineToolAnchoredVolumeProfile:s.t(null,{context:"study"},i(689633)),LineToolRotatedRectangle:s.t(null,void 0,i(56820)),LineToolSchiffPitchfork:s.t(null,void 0,i(657681)),LineToolSchiffPitchfork2:s.t(null,void 0,i(942608)),LineToolSineLine:s.t(null,void 0,i(839090)),LineToolText:s.t(null,{context:"tool"},i(691405)),LineToolTextAbsolute:s.t(null,void 0,i(642669)),LineToolThreeDrivers:s.t(null,void 0,i(46982)),LineToolTimeCycles:s.t(null,void 0,i(746852)),LineToolTrendAngle:s.t(null,void 0,i(35757)),LineToolTrendBasedFibExtension:s.t(null,void 0,i(680583)),LineToolTrendBasedFibTime:s.t(null,void 0,i(272159)),LineToolTrendLine:s.t(null,void 0,i(197339)),LineToolInfoLine:s.t(null,void 0,i(715992)),LineToolTriangle:s.t(null,void 0,i(901671)),LineToolTrianglePattern:s.t(null,void 0,i(390148)),LineToolVertLine:s.t(null,void 0,i(529535)),LineToolCrossLine:s.t(null,void 0,i(974334)),LineToolHighlighter:s.t(null,void 0,i(969476)),LineToolPriceNote:s.t(null,void 0,i(297512)),LineToolVbPFixed:s.t(null,void 0,i(840693)),LineToolGhostFeed:s.t(null,void 0,i(546808)),LineToolTable:s.t(null,void 0,i(17981))};n.LineToolTweet=s.t(null,void 0,i(636549)),n.LineToolIdea=s.t(null,void 0,i(215982)),n.LineToolNoteAbsolute=s.t(null,void 0,i(363209))},774440:(e,t,i)=>{i.d(t,{StudyLineDataSource:()=>P,isStudyLineTool:()=>f});var s=i(132565),n=i(318945),r=i(312692),o=i(807958),l=i(196302),a=i(479483),d=i(590178),h=i(808825),u=i(587482),c=i(37241),_=i(437642),p=i(454184),y=i(232915);class m extends y.StatusProviderBase{constructor(e){super(),this._source=e}errorStatus(){const e=this._source.status();return e.type===p.StudyStatusType.Error?{error:this.sourceStatusText(),solutionId:(0,p.studyStatusSolutionId)(e),title:(0,p.studyStatusTitle)(e),studyFeature:(0,p.studyStatusFeature)(e)}:null}getSplitTitle(){
return this._source.titleInParts()}text(){return this._source.translatedType()}sourceStatusText(){return(0,p.convertStudyStatusToString)(this._source.status(),!0)}}var g=i(239949),S=i(236578);class v extends S.StatusView{constructor(e){super(e.statusProvider({}))}getSplitTitle(){return this._statusProvider.getSplitTitle()}}function f(e){return e instanceof P}class P extends n.LineDataSource{constructor(e,t,s,n,r,o){super(e,n,r,o),this._indexes=null,this._inputs=null,this._definitionsViewModel=null,this._pointsetPoints=null,this._loadedPlots=null,this._loadedGraphics=null,this._beingCreatedPaneView=null,this._anchorsPaneView=null,this._isLegendDisplayed=!1,Promise.all([Promise.all([i.e(22296),i.e(63317),i.e(4171),i.e(88914),i.e(62622),i.e(9517),i.e(5262),i.e(51583)]).then(i.bind(i,473410)),Promise.all([i.e(22296),i.e(63317),i.e(4171),i.e(88914),i.e(62622),i.e(9517),i.e(5262),i.e(51583)]).then(i.bind(i,768260))]).then((t=>{const{LineToolBeingCreatedPaneView:i}=t[0],{StudyLineDataSourceAnchorsPaneView:s}=t[1];this._beingCreatedPaneView=new i(this,e),this._anchorsPaneView=new s(this,this.model()),this._model.lightUpdate()})),this._metaInfo=t,this._dataSource=new d.ExtendedStudyDataSource(e.chartApi(),e.mainSeries(),s,t),this._dataSource.dataCleared().subscribe(this,this._onDataCleared),this._dataSource.dataUpdated().subscribe(this,this._onDataUpdated),this._dataSource.studyStatusChanged().subscribe(this,this._onStudyStatusChanged),this._statusProvider=new m(this),this._statusView=new v(this),this._showStudyArgumentsProperty=e.properties().childs().paneProperties.childs().legendProperties.childs().showStudyArguments}isDisplayedInLegend(){return this._isLegendDisplayed}titleInParts(){const e=[];if(this._showStudyArgumentsProperty.value()&&this._inputs)for(const t of this._metaInfo.inputs){if(!0===t.isHidden||"bool"===t.type)continue;const i=this._inputs[t.id];e.push(i.toString())}return[this.name(),e]}destroy(){this._dataSource.dataUpdated().unsubscribeAll(this),this._dataSource.dataCleared().unsubscribeAll(this),this._dataSource.studyStatusChanged().unsubscribeAll(this),this._dataSource.destroy(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),this._unsubscribeApplyInputsOnSeriesCompleted(),this._isDestroyed=!0,super.destroy()}stop(){super.stop(),this._stopDataSource()}start(){super.start(),this._startDataSource()}metaInfo(){return this._metaInfo}graphicsInfo(){return this._metaInfo.graphics}series(){return this._model.mainSeries()}translatedType(){return this._metaInfo.description}name(){return this._metaInfo.description}studyId(){return this._metaInfo.id}setPoint(e,t,i){super.setPoint(e,this._preparePoint(t,i))}move(e){}clearData(){this._pointsetPoints=null,this._clearAllDataExceptPointsetPoints(),this._onStudyInputsMayChange(),this.updateAllViews((0,_.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),super.clearData()}data(){return this.plots()}plots(){return this._loadedPlots||this._dataSource.plots()}graphics(){
return this._loadedGraphics||this._dataSource.graphics()}valueAt(e,t){return this.ownerSource()?.symbolSource().valueAt(e,t)??null}firstValue(){return this._model.mainSeries().firstValue()}state(e){const t={...super.state(e),metaInfo:this.metaInfo().state()};return e&&(t.data=this.plots().state(),t.nonseriesindexes=this._indexes,t.graphics=(0,l.saveStudyGraphics)(this.graphics(),null)),t}restoreData(e){void 0!==e.data&&(this._loadedPlots=new s.PlotList((0,u.studyPlotFunctionMap)(this._metaInfo),u.studyEmptyPlotValuePredicate),this._loadedPlots.restoreState(e.data)),this._indexes=e.nonseriesindexes??this._indexes,this._loadedGraphics=e.graphics?(0,l.loadStudyGraphics)(e.graphics):this._loadedGraphics}getPropertyDefinitionsViewModel(){return null===this._definitionsViewModel?this._getPropertyDefinitionsViewModelClass().then((e=>null===e||this._isDestroyed?null:(null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this._model.undoModel(),this)),this._definitionsViewModel))):Promise.resolve(this._definitionsViewModel)}paneViews(e){let t=[];if(this.isSourceHidden())return t;if(this._isReady()&&this._changeStatesStack.isEmpty()){const i=super.paneViews(e);null!==i&&(t=t.concat(i))}else null!==this._beingCreatedPaneView&&t.push(this._beingCreatedPaneView);return null!==this._anchorsPaneView&&t.push(this._anchorsPaneView),t}propertiesChanged(e){super.propertiesChanged(e),this._onStudyInputsMayChange()}dataAndViewsReady(){return super.dataAndViewsReady()&&this._isReady()}endChanging(e,t){const i=super.endChanging(e,t);return i.indexesChanged?this.clearData():this._updateAnchorsPrice(!0),i}moveData(e){this._dataSource.moveData(e)}restorePoints(e,t,i){super.restorePoints(e,t,i),this._updateAnchorsPrice(!0)}statusProvider(e){return this._statusProvider}statusView(){return this._statusView}legendView(){return null}dataProblemModel(){return null}dataUpdatedModeModel(){return null}marketStatusModel(){return null}onStatusChanged(){return this._dataSource.studyStatusChanged()}status(){return this._dataSource.studyStatus()}recalcStudyIfNeeded(){}static createPropertiesFromStudyMetaInfoAndState(e,t,i,s,n){const r=(0,c.prepareStudyPropertiesForLoadChart)(e,t,i,s,void 0,n);return this._configureProperties(r),r}_getPointsetPoints(){return this._pointsetPoints}_onStudyStatusChanged(e,t){let i;switch(t.type){case h.StudyStatusType.Error:i=!0;break;case h.StudyStatusType.Completed:i=!1;break;default:return}if(i===this._isLegendDisplayed)return;this._isLegendDisplayed=i;const s=this._model.paneForSource(this);if(s){const e=this._model.panes().indexOf(s),t=g.InvalidationMask.invalidateLegendWidgetLayout(e);this.model().invalidate(t)}}_studyId(){return this._dataSource.studyId()}_isReady(){return!0}_updateAllPaneViews(e){super._updateAllPaneViews(e),this._beingCreatedPaneView?.update(),this._anchorsPaneView?.update(e)}_getPointTime(e,t){const i=e.index,s=this._model.timeScale().indexToTimePoint(i);return null!==s?s:t||void 0===e.time?null:this._utcTimeInCurrentResolution(e)}_updateAnchorsPrice(e){}_onPointsetUpdated(e){
super._onPointsetUpdated(e),this._pointsetPoints=this._points.map((e=>({price:e.price,index:e.index,time:e.time}))),this._onStudyInputsMayChange()}_onDataCleared(){this.updateAllViews((0,_.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),this._model.updateSource(this)}_onDataUpdated(e,t,i){this._updateAnchorsPrice(),this.updateAllViews((0,_.sourceChangeEvent)({sourceId:this.id(),firstUpdatedTimePointIndex:e[0]?.index})),this._model.updateSource(this)}_onStudyInputsMayChange(){let e=null;const t=this._pointsetPoints;if(t?.length===this.pointsCount()){if(e=this._studyInputs(t),e){const t=this.metaInfo().inputs.map((e=>e.id));for(const i of Object.keys(e))t.includes(i)||delete e[i]}}else this._isDataSourceStarted()&&this._stopDataSource(!1);e?this._unsubscribeApplyInputsOnSeriesCompleted():this._subscribeApplyInputsOnSeriesCompleted(),this._areInputsEqual(this._inputs,e)||(this._applyStudyInputs(e),e?this._isDataSourceStarted()||this._startDataSource():(this._clearAllDataExceptPointsetPoints(),this.updateAllViews((0,_.sourceChangeEvent)(this.id()))))}_preparePoint(e,t){return super._preparePoint(this._alignPointToRangeOfActualData(e),t)}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_subscribeApplyInputsOnSeriesCompleted(){this._unsubscribeApplyInputsOnSeriesCompleted(),this._model.mainSeries().dataEvents().completed().subscribe(this,(()=>this._onStudyInputsMayChange()),!0)}_unsubscribeApplyInputsOnSeriesCompleted(){this._model.mainSeries().dataEvents().completed().unsubscribeAll(this)}_onInputsChanged(){this.hasAlert().value()&&(this._localAndServerAlertsMismatch=!0)}_clearAllDataExceptPointsetPoints(){this._loadedPlots=null,this._indexes=null,this._loadedGraphics=null,this._dataSource.clearData()}_stopDataSource(e=!0){this._isDestroyed||(this._dataSource.stop(),e&&this.clearData())}_startDataSource(){this._isDestroyed||null===this._inputs||this._dataSource.start()}_isDataSourceStarted(){return this._dataSource.isStarted()}static _createPropertiesFromStudyIdAndState(e,t){const i=o.StudyMetaInfo.getStudyPropertyRootNameById(e),s=new r.DefaultProperty({defaultName:i,state:t});return this._configureProperties(s),s}static _configureProperties(e){super._configureProperties(e),e.removeExcludedKey("intervalsVisibilities",1),e.removeProperty("showLegendValues"),e.removeProperty("showLegendInputs")}_areInputsEqual(e,t){return null===t?null===e:null!==e&&(0,a.areStudyInputsEqual)(this._metaInfo.inputs,e,t)}_applyStudyInputs(e){this._inputs=e,null!==e&&this._dataSource.setInputs(e),this._onInputsChanged()}}},37241:(e,t,i)=>{i.d(t,{prepareStudyProperties:()=>b,prepareStudyPropertiesForLoadChart:()=>m});var s=i(998034),n=i(130551),r=i(735566),o=i(536794),l=i(807958),a=i(257145),d=i(85858),h=i(192809),u=i(266954),c=i(312692),_=i(744380),p=i(974145);const y=(0,r.getLogger)("Chart.Study");function m(e,t,i,n,r,a){return function(e,t,i,n,r,a,h){const u=function(e,t,i,n,r){
e.version&&i.version&&e.version!==i.version&&y.logWarn("Serialized metaInfo version "+e.version+" is not equal to the saved state version "+i.version);const a=t||e,h=(0,o.clone)(a.defaults)??{},u=l.StudyMetaInfo.getStudyPropertyRootName(a),c=l.StudyMetaInfo.getStudyPropertyRootName(e);let _=S();(0,s.default)(_,g(e)),(0,s.default)(_,(0,o.clone)(e.defaults)),(0,s.default)(_,h),(0,s.default)(_,(0,d.factoryDefaults)(u)),(0,s.default)(_,(0,d.factoryDefaults)(c)),(0,s.default)(_,v(a,n,u)),(0,s.default)(_,v(e,n,c)),(0,s.default)(_,i),_=n.updateStudyState(_,e,t),void 0!==r&&t&&(_=r(i,_,e,t));l.StudyMetaInfo.versionOf(a)>=1&&(0,s.default)(_,f(h,_));return _}(e,t,i,n,a);return A(t||e,r,u,h,!0)}(e,t,i,n,l.StudyMetaInfo.getStudyPropertyRootName(e),r,a)}function g(e){const t={};if(e.plots)for(let i=0;i<e.plots.length;i++){const s=e.plots[i],n=s.id;if((0,p.isColorerPlot)(s))continue;const r={display:15,color:"#0496FF",linestyle:a.LINESTYLE_SOLID,linewidth:2,plottype:p.LineStudyPlotStyle.Line,trackPrice:!1};(0,p.isBarColorerPlot)(s)&&(r.transparency=0),r.plottype=s.type,r.title=n,t[n]=r}return{styles:t}}function S(){const e=(0,o.clone)((0,d.defaults)("study"));return e.intervalsVisibilities=(0,o.clone)(u.intervalsVisibilitiesDefaults),e}function v(e,t,i){let s=(0,o.clone)((0,d.defaults)(i,t));return"Overlay"!==e.shortId&&"Compare"!==e.shortId||(s.currencyId=null,s.unitId=null),e.isTVScript&&e.TVScriptSourceCode!==s.TVScriptSourceCode&&(s=(0,o.clone)((0,d.factoryDefaults)(i))),s}function f(e,t){const i={};return h.StudyVersioning.mergeInputsObjPart(i,e.inputs??{}),h.StudyVersioning.mergeInputsObjPart(i,t.inputs),{inputs:i}}function P(e,t,i,r){if(l.StudyMetaInfo.versionOf(e)<1)throw new Error("This function cannot work with metainfo of the old format version. Required format version >= 1");const a=l.StudyMetaInfo.getStudyPropertyRootName(e),h=(0,o.clone)(e.defaults),u=(0,d.factoryDefaults)(a),c=S();if((0,s.default)(c,g(e)),(0,s.default)(c,h),(0,s.default)(c,u),(0,s.default)(c,v(e,r,a)),(0,s.default)(c,t),(0,s.default)(c,f(h,c)),null!==i){const t=i.model().studiesColorRotatorFactory().getColorRotator(e);null!==t&&("Overlay@tv-basicstudies"===e.id?c.lineStyle.color=t.getColor(c.lineStyle.color,u.lineStyle.color===c.lineStyle.color):(0,s.default)(c,function(e,t){for(const i of Object.keys(e.styles)){const s=e.styles[i];if((0,n.isObject)(s)&&"color"in s){const e=s.color;s.color=t.getColor(e)}}return e}(c,t)))}return r.updateStudyInputsIfNeeded(c,c.version??e.version,e),c}function b(e,t,i,s,n){return function(e,t,i,s,n,r){const a=P(e,t,i,s),d=l.StudyMetaInfo.getSourceInputIds(e);return d.forEach(((e,t)=>{const i=a.inputs[e];t<r.length?a.inputs[e]=`${r[t].id()}$0`:(0,o.isString)(i)&&i.includes("$")&&(a.inputs[e]="close")})),A(e,n,a)}(e,t,i,s,l.StudyMetaInfo.getStudyPropertyRootName(e),n)}
const C=["id","description","description_localized","shortDescription","_metainfoVersion","is_price_study","is_hidden_study","priceScale","fullId","shortId","scriptIdPart","packageId","productId","isTVScriptStub","defaults","symbolSource","historyCalculationMayChange","format","linkedToSeries","isTVLibrary","docs","exports","exportTypes","extra","usesPrivateLib","financialPeriod","groupingKey","pine","isRGB","isTVScript","TVScriptMetaInfoExprs","usePlotsZOrder","isTVScriptStrategy","TVScriptSourceCode","lookaheadFutureData","hasAlertFunction","defaultStrategyAlertMessage","tags","canBeChild","canNotBeChild","_serverMetaInfoVersion","warnings"];function A(e,t,i,s,n){for(const e of C)delete i[e];const r=["visible","precision","minTick","intervalsVisibilities","inputs.first_visible_bar_time","inputs.last_visible_bar_time","inputs.subscribeRealtime","patchMetaInfoDefaults"];for(let t=0;t<e.inputs.length;++t){const i=e.inputs[t];i.isHidden&&(r.push(`inputs.${t}`),r.push(`inputs.${i.id}`))}const o=new c.DefaultProperty({defaultName:t,state:i,excludedDefaultsKeys:r,excludedStateKeys:["version"],theme:s});o.removeProperty("intervalsVisibilities"),o.addChild("intervalsVisibilities",new _.IntervalsVisibilitiesProperty(i&&i.intervalsVisibilities)),"PivotPointsStandard@tv-basicstudies"!==e.id&&"PivotPointsHighLow@tv-basicstudies"!==e.id||!o.hasChild("font")||o.removeProperty("font");const a=l.StudyMetaInfo.versionOf(e);return o.hasChild("version")?o.childs().version?.setValue(a):o.addProperty("version",a),e.TVScriptMetaInfoExprs&&!n&&o.addProperty("patchMetaInfoDefaults",!0),o}},590178:(e,t,i)=>{i.d(t,{ExtendedStudyDataSource:()=>r});var s=i(901466),n=i(454184);class r extends s.StudyDataSource{constructor(e,t,i,s){super(e,t.seriesSource(),i,s),this._series=t}_createStudyError(e){return(0,n.createStudyError)(this._getStudyErrorDescription(e),this._series.symbolInfo()?.exchange)}}},901466:(e,t,i)=>{i.r(t),i.d(t,{StudyDataSource:()=>p});var s=i(650151),n=i(547465),r=i(132565),o=i(359035),l=i(807958),a=i(259710),d=i(587482),h=i(284881),u=i(808825);const c=(0,i(735566).getLogger)("Chart.StudyDataSource");var _;!function(e){e[e.Idle=0]="Idle",e[e.AwaitingConnection=1]="AwaitingConnection",e[e.AwaitingParent=2]="AwaitingParent",e[e.AwaitingFirstDataUpdate=3]="AwaitingFirstDataUpdate",e[e.Active=4]="Active"}(_||(_={}));class p{constructor(e,t,i,s,o=!1){this._inputs=null,this._status=_.Idle,this._studyId=null,this._turnaroundCounter=1,this._studyStatus={type:u.StudyStatusType.Undefined},this._studyStatusChanged=new n.Delegate,this._dataCleared=new n.Delegate,this._dataUpdated=new n.Delegate,this._boundOnGatewayIsConnectedChanged=this._onGatewayIsConnectedChanged.bind(this),this._ongoingDataUpdate=Promise.resolve(),this._gateway=e,this._metaInfo=s,this._forceUseExclamationMark=o,this._seriesSource=t,this._turnaroundPrefix=i,this._plots=new r.PlotList((0,d.studyPlotFunctionMap)(s),d.studyEmptyPlotValuePredicate),this._gateway.isConnected().subscribe(this._boundOnGatewayIsConnectedChanged),this._graphics=new h.LiveStudyGraphics(s.graphics)
}destroy(){this.stop(),this._gateway.isConnected().unsubscribe(this._boundOnGatewayIsConnectedChanged),this._seriesSource.dataEvents().created().unsubscribeAll(this)}metaInfo(){return this._metaInfo}inputs(){return this._inputs}setInputs(e){this._inputs=e,null!==this._studyId&&(this._turnaroundCounter++,this._onStudyStatusChangedTo({type:u.StudyStatusType.Undefined}),this._gateway.modifyStudy(this._studyId,this._turnaround(),e,this._onMessage.bind(this)),this._status===_.Active&&this._changeStatusTo(_.AwaitingFirstDataUpdate))}isStarted(){return this._status!==_.Idle}isActive(){return this._status===_.Active}start(){this.isStarted()?c.logNormal("start: data source is already started, nothing to do"):((0,s.assert)(null!==this._inputs,"Inputs should be defined when starting a study data source"),this._gateway.isConnected().value()?this._createStudy():this._changeStatusTo(_.AwaitingConnection))}stop(){this.isStarted()?(null!==this._studyId&&(this._gateway.isConnected().value()&&this._gateway.removeStudy(this._studyId),this._studyId=null,this._onStudyStatusChangedTo({type:u.StudyStatusType.Undefined})),this._changeStatusTo(_.Idle)):c.logNormal("stop: data source is already stopped, nothing to do")}studyId(){return this._studyId}studyStatus(){return this._studyStatus}studyStatusChanged(){return this._studyStatusChanged}plots(){return this._plots}graphics(){return this._graphics}clearData(){this._plots.clear(),this._graphics.clear(),this._dataCleared.fire()}stopAndStealData(){(0,s.assert)(this._status===_.Active,"Couldn't steal data from non-active data source"),this.stop();const e=this._plots,t=this._graphics.extract();return this._plots=new r.PlotList((0,d.studyPlotFunctionMap)(this._metaInfo),d.studyEmptyPlotValuePredicate),{plots:e,graphics:t}}dataCleared(){return this._dataCleared}dataUpdated(){return this._dataUpdated}moveData(e){this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._plots.move(e)}))}pendingUpdatesReady(){return this._ongoingDataUpdate}_createStudyError(e){return{type:u.StudyStatusType.Error,errorDescription:this._getStudyErrorDescription(e)}}_getStudyErrorDescription(e){return"string"==typeof e?{error:e.split(":",2)[0]}:e}_changeStatusTo(e){(0,s.assert)(this._status!==e,"Source and destination status should be distinct"),c.logNormal(`Status changed from ${_[this._status]} to ${_[e]}`),this._status=e}_createStudy(){const e=this._seriesSource.instanceId();null!==e?this._createStudyUsingParentId(e):(this._changeStatusTo(_.AwaitingParent),this._seriesSource.dataEvents().created().subscribe(this,this._onSeriesCreated,!0))}_createStudyUsingParentId(e){(0,s.assert)(this._status!==_.Active,'Status should not be "Active" when creating a study'),(0,s.assert)(this._studyStatus.type===u.StudyStatusType.Undefined,'Study status should be "Undefined" when creating a study'),(0,s.assert)(null===this._studyId,"Study id should be empty when creating a study"),this._studyId=(0,a.makeNextStudyId)(),
this._gateway.createStudy(this._studyId,this._turnaround(),e,l.StudyMetaInfo.getStudyIdWithLatestVersion(this.metaInfo(),this._forceUseExclamationMark),(0,s.ensureNotNull)(this._inputs),this._onMessage.bind(this),{id:this._metaInfo.id}),this._changeStatusTo(_.AwaitingFirstDataUpdate)}_onGatewayIsConnectedChanged(e){e?this._onGatewayConnected():this._onGatewayDisconnected()}_onGatewayConnected(){this._status===_.AwaitingConnection&&this._createStudy()}_onGatewayDisconnected(){this._status!==_.Idle&&this._status!==_.AwaitingConnection&&(this._studyId=null,this._changeStatusTo(_.AwaitingConnection),this._studyStatus.type!==u.StudyStatusType.Undefined&&this._onStudyStatusChangedTo({type:u.StudyStatusType.Undefined})),this._turnaroundCounter=1}_onSeriesCreated(){this._status===_.AwaitingParent&&this._createStudyUsingParentId((0,s.ensure)(this._seriesSource.instanceId()))}_onStudyStatusChangedTo(e){const t=this._studyStatus;this._studyStatus=e,c.logNormal(`Study status type changed from ${u.StudyStatusType[t.type]} to ${u.StudyStatusType[e.type]}`),this._studyStatusChanged.fire(t,e)}_onMessage(e){if("data_update"===e.method){const{customId:t,turnaround:i,plots:n,nonseries:r}=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onDataUpdate(n,(0,s.ensureDefined)(r))}else if("study_loading"===e.method){const[t,i]=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onStudyLoading(e.time)}else if("study_completed"===e.method){const[t,i]=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onStudyCompleted(e.time)}else if("study_error"===e.method){const[t,i,s,n]=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onStudyError(s,n,e.time)}else"clear_data"===e.method&&this._checkTurnaround(e.params.turnaround)&&this.clearData()}_onDataUpdate(e,t){const i=(0,o.unpackNonSeriesData)(t.d);return this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>i),(()=>i)).then(this._onDataUnpacked.bind(this,e,t.indexes)),this._ongoingDataUpdate}_onDataUnpacked(e,t,i){this._status!==_.Idle&&(this._status===_.AwaitingFirstDataUpdate&&(this._changeStatusTo(_.Active),this.clearData()),this._mergePlots(e),null!==i&&(i.indexes_replace?((0,s.assert)("nochange"!==t),this._graphics.replaceIndexesTo(t)):("nochange"!==t&&this._graphics.replaceIndexesTo(t),void 0!==i.graphicsCmds&&this._graphics.processCommands(i.graphicsCmds))),this._dataUpdated.fire(e,i,t))}_onStudyLoading(e){this._onStudyStatusChangedTo({type:u.StudyStatusType.Loading,startTime:Date.now()})}_onStudyError(e,t,i){this.clearData(),this._onStudyStatusChangedTo(this._createStudyError(e))}_onStudyCompleted(e){this._onStudyStatusChangedTo({type:u.StudyStatusType.Completed})}_mergePlots(e){this._plots.merge(e)}_turnaround(){return`${this._turnaroundPrefix}${this._turnaroundCounter}`}_checkTurnaround(e){const t=this._turnaround();return e===t||e===this._seriesSource.turnaround()||e===`${this._seriesSource.turnaround()}_${t}`}}},616427:(e,t,i)=>{i.d(t,{areEqualSymbols:()=>o,compareSymbolParams:()=>h,symbolParams:()=>d,symbolSameAsCurrent:()=>a});i(213377)
;var s=i(388741),n=i(477786);const r=!0;function o(e,t){return void 0===e?void 0===t:void 0!==t&&(r?e.toUpperCase()===t.toUpperCase():e===t)}function l(e,t){return e.some((e=>o(t,e)))}function a(e,t){if(null===t)return!1;if(t){if(o(t.full_name,e)||o(t.pro_name,e))return!0;if(o(t.ticker,e))return!0;if(t.aliases&&l(t.aliases,e))return!0;if(t.alternatives&&l(t.alternatives,e))return!0;if(0===e.indexOf("FRA:")&&o(t.pro_name,e.replace("FRA:","FWB:")))return!0}return!1}function d(e){return{symbol:e.symbol(),currency:e.currency(),unit:e.unit(),interval:e.interval(),style:e.style()}}function h(e,t,i){const{symbol:r,currency:o,unit:l,style:a,interval:d}=t,h=void 0!==r&&!e.symbolSameAsResolved(r);let u,c;const _=e.symbolInfo();null!==_?(u=void 0!==o&&!function(e,t){return null===e&&!(0,s.isConvertedToOtherCurrency)(t)||e===(0,s.symbolCurrency)(t)}(o,_),c=void 0!==l&&!function(e,t,i){return null===e&&!(0,s.isConvertedToOtherUnit)(t,i)||e===(0,s.symbolUnit)(t,i)}(l,_,i)):(u=void 0!==o&&o!==e.currency(),c=void 0!==l&&l!==e.unit());return{symbolChanged:h,intervalChanged:void 0!==d&&!n.Interval.isEqual(e.interval(),d),currencyChanged:u,unitChanged:c,styleChanged:void 0!==a&&a!==e.style(),styleChangeRequiresRestart:void 0!==a&&(0,s.styleChangeRequiresRestart)(a,e.style())}}},87521:(e,t,i)=>{i.d(t,{TimeAxisView:()=>o});var s=i(534328),n=i(688857);class r{constructor(){this._data=null}setData(e){this._data=e}draw(e,t,i){if(null===this._data||!this._data.visible||0===this._data.text.length)return;const s=this._data;e.font=i.font;const r=Math.round(i.widthCache.measureText(e,s.text));if(r<=0)return;e.save();const o=i.paddingHorizontal,l=r+2*o,a=l/2;let d=s.coordinate,h=Math.floor(d-a)+.5;if(s.alwaysInViewPort){const e=s.width;h<0?(d+=Math.abs(0-h),h=Math.floor(d-a)+.5):h+l>e&&(d-=Math.abs(e-(h+l)),h=Math.floor(d-a)+.5)}const u=h+l,c=Math.ceil(0+i.borderSize+i.offsetSize+i.paddingTop+i.fontSize+i.paddingBottom),{horizontalPixelRatio:_,verticalPixelRatio:p}=t;e.fillStyle=s.background;const y=Math.round(h*_),m=Math.round(0*p),g=Math.round(u*_),S=Math.round(c*p),v=Math.round(2*_);e.beginPath(),e.moveTo(y,m),e.lineTo(y,S-v),e.arcTo(y,S,y+v,S,v),e.lineTo(g-v,S),e.arcTo(g,S,g,S-v,v),e.lineTo(g,m),e.fill();const f=0+i.borderSize+i.offsetSize+i.paddingTop+i.fontSize/2;e.textAlign="left",e.textBaseline="middle",e.fillStyle=s.color;const P=i.widthCache.yMidCorrection(e,"Apr0");e.translate((h+o)*_,(f+P)*p),(0,n.drawScaled)(e,_,p,(()=>e.fillText(s.text,0,0))),e.restore()}}class o{constructor(e){this._renderer=new r,this._rendererData={background:"",color:"",coordinate:0,text:"",visible:!1,width:0,alwaysInViewPort:!0},this._invalidated=!0,this._model=e,this._renderer.setData(this._rendererData)}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}coordinate(){return this._rendererData.coordinate}_getAlwaysInViewPort(){return!0}_getText(e){const t=this._model.timeScale().indexToUserTime(e);return null!==t?this._model.dateTimeFormatter().format(t):""}_updateImpl(){
const e=this._rendererData;if(e.visible=!1,this._model.timeScale().isEmpty()||!this._isVisible())return;const t=this._getIndex();null!==t&&Number.isFinite(t)&&(e.visible=!0,e.width=this._model.timeScale().width(),e.background=this._getBgColor(),e.color=(0,s.colorFromBackground)(e.background),e.coordinate=this._model.timeScale().indexToCoordinate(t),e.alwaysInViewPort=this._getAlwaysInViewPort(),e.text=this._getText(t),this._invalidated=!1)}}},422063:(e,t,i)=>{i.d(t,{UndoCommand:()=>n});var s=i(418450);class n{constructor(e,t=!0,i=!0){this._text=e||new s.TranslatedString("",""),this._executeOnPush=t,this._affectsState=i}text(){return this._text}executeOnPush(){return this._executeOnPush}affectsState(){return this._affectsState}canMerge(e){return!1}merge(e){throw new Error("Should be re-implemented in child classes")}}},75060:(e,t,i)=>{i.d(t,{canPlaceAlertOnResolution:()=>r});var s=i(477786),n=i(925470);function r(e,t){const i=s.Interval.isSeconds(e),r=t?t?.alertsOnSeconds:(0,n.enabled)("ALERTS_ON_SECONDS");return!i||r}},677500:(e,t,i)=>{i.d(t,{getChartAlertsFacade:()=>l,getChartAlertsFacadeIfCreatedBefore:()=>a});var s=i(9880),n=i(154890);let r,o;async function l(){return r||(r=async function(){const[e,{getAlertsCollection:t},r,o]=await Promise.all([Promise.all([i.e(32856),i.e(25558),i.e(50030),i.e(70217),i.e(89774),i.e(52768),i.e(98634),i.e(4943),i.e(36679)]).then(i.bind(i,299451)),Promise.all([i.e(83477),i.e(83455),i.e(50030),i.e(89774),i.e(52768),i.e(98634),i.e(14141)]).then(i.bind(i,252768)),(0,n.getChartSourceIdsGetter)(),(0,s.getAlertsFiresFocusHandler)()]);return new e.ChartAlertsFacade(t(),o,r)}()),o||(o=await r),o}function a(){return o??null}},154890:(e,t,i)=>{i.d(t,{getChartSourceIdsGetter:()=>s});const s=(0,i(481251).default)((async()=>{const{ChartSourceIdsGetter:e}=await Promise.all([i.e(35706),i.e(50030),i.e(67447),i.e(89774),i.e(52768),i.e(98634),i.e(22369),i.e(79979)]).then(i.bind(i,517696));return new e}))},234938:(e,t,i)=>{i.d(t,{showGoProAlertsOnSecondsDialog:()=>n});var s=i(707934);i(659863);function n(){(0,s.createGoProDialog)({feature:"alertsOnSeconds"})}}}]);